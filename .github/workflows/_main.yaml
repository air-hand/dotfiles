name: Main Jobs

on:
  workflow_call:
    secrets:
      GH_APP_ID:
        required: true
      GH_APP_PEM_FILE:
        required: true
      TF_API_TOKEN:
        required: true
      TF_CLOUD_ORGANIZATION:
        required: true
      GH_APP_INSTALLATION_ID:
        required: true

permissions: {}

jobs:
  labeler:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 10
    steps:
      # use GitHub Apps token to run other actions.
      - uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: gh-app-token
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PEM_FILE }}
          permission-contents: read
          permission-pull-requests: write
      - uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6.0.1
        with:
          repo-token: ${{ steps.gh-app-token.outputs.token }}

  ci-jobs:
    uses: ./.github/workflows/_ci.yaml
    permissions:
      contents: read
      statuses: write
      pull-requests: read

  iac-jobs:
    needs: labeler
    if: contains(github.event.pull_request.labels.*.name, 'terraform-deps')
    uses: ./.github/workflows/_iac.yaml
    permissions:
      contents: read
      pull-requests: write
    secrets:
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
      TF_CLOUD_ORGANIZATION: ${{ secrets.TF_CLOUD_ORGANIZATION }}
      GH_APP_ID: ${{ secrets.GH_APP_ID }}
      GH_APP_INSTALLATION_ID: ${{ secrets.GH_APP_INSTALLATION_ID }}
      GH_APP_PEM_FILE: ${{ secrets.GH_APP_PEM_FILE }}
